# RFC 001: MQG v6.4 Format Support

**Status:** Implemented
**Date:** 2024-12-16
**Author:** Claude Code

---

## Summary

This RFC documents how QTI-Generator parses MQG v6.4 format files. It establishes the canonical field formats that the parser expects.

---

## Background

MQG v6.4 uses explicit `@end_field` markers for unambiguous field boundaries. This change from v6.3 enables:

- Nested fields (e.g., feedback subsections inside feedback parent)
- Content that safely contains `@field:` or `###` text
- Stack-based parsing for correct parent/child relationships

---

## v6.4 Format Specification

### Field Markers

| Marker | Purpose |
|--------|---------|
| `@field: identifier` | Start a named field |
| `@end_field` | End the current field |
| `@question: Q001` | Question machine ID |
| `@type: question_type` | Question type |
| `@identifier: UNIQUE_ID` | Unique identifier |
| `@points: N` | Point value |
| `@tags: #tag1 #tag2` | Hashtag-prefixed tags |

### Formatting Conventions

| Convention | Format | Example |
|------------|--------|---------|
| Bold labels | Colon inside bold | `**Correct Answers:**` not `**Correct Answers**:` |
| Dropdown correct | `*` suffix | `- option*` marks correct answer |
| Boolean values | `Yes`/`No` | `**Case Sensitive:** No` |
| Lists under labels | Newline + `-` items | See examples below |

---

## Question Type Formats

### text_entry

Blank fields use `**Correct Answers:**` with a list of accepted values:

```markdown
@field: blank_1
**Correct Answers:**
- primary_answer
- alternative1
- alternative2
**Case Sensitive:** No
@end_field
```

**Parser behavior:**
- First list item is primary answer
- All items are accepted as correct
- Case sensitivity applies to all answers

### inline_choice

Dropdown fields use `*` suffix to mark the correct answer:

```markdown
@field: dropdown_1
- wrong_option
- correct_option*
- another_wrong
@end_field
```

**Parser behavior:**
- Lines starting with `-` are options
- Option ending with `*` is correct (asterisk stripped)
- Order preserved for display

### multiple_choice_single

Standard options with letter prefix, answer as single letter:

```markdown
@field: options
A. First option
B. Second option
C. Third option
D. Fourth option
@end_field

@field: answer
B
@end_field
```

### multiple_response

Same options format, comma-separated correct answers:

```markdown
@field: options
A. Option 1
B. Option 2
C. Option 3
D. Option 4
@end_field

@field: correct_answers
A, C, D
@end_field
```

### match

Pairs with `->` separator, distractors as list:

```markdown
@field: pairs
1. Premise one -> Response one
2. Premise two -> Response two
3. Premise three -> Response three
@end_field

@field: distractors
- Wrong distractor 1
- Wrong distractor 2
@end_field
```

---

## Feedback Structure

Feedback uses nested fields:

```markdown
@field: feedback

@field: general_feedback
Explanation shown to all students...
@end_field

@field: correct_feedback
Shown when answer is correct...
@end_field

@field: incorrect_feedback
Shown when answer is incorrect...
@end_field

@field: partial_feedback
Shown for partial credit...
@end_field

@field: unanswered_feedback
Shown when not answered...
@end_field

@end_field
```

---

## Parser Implementation Notes

### Stack-Based Parsing

The parser uses a stack to track nested fields:

1. `@field: X` pushes field onto stack
2. Content accumulates until `@end_field`
3. `@end_field` pops field and stores content
4. Nested fields become children of parent

### Legacy Fallback

When v6.4 extraction yields empty results, parser falls back to legacy patterns:

```python
if not sections.get('blanks'):
    # Try v6.3 legacy extraction
```

This ensures backward compatibility during migration.

---

## Migration from v6.3

v6.3 files need these changes for v6.4:

1. Add `@end_field` after each field's content
2. Nest feedback subsections inside `@field: feedback ... @end_field`
3. Use `**Label:**` format (colon inside bold)
4. Use `*` for dropdown correct answers

---

## References

- MQG BB6 v6.4 Spec: `MPC_MQG_v2/docs/specs/MQG_bb6_v6.4.md`
- Parser: `src/parser/markdown_parser.py`
