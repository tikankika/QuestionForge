# RFC 002: MQG v6.5 - Unified Syntax Format

**Status:** Implemented
**Date:** 2024-12-16
**Author:** Claude Code

---

## Summary

This RFC documents v6.5 of the MQG format, which introduces unified syntax with `^` for all metadata and `@@` for subfields.

---

## Problem

v6.4 mixed different syntaxes:

```markdown
@field: blank_1
**Correct Answers:**
- 42
**Case Sensitive:** No
@end_field
```

Issues:
1. **Mixed formats** - `@` markers + `**bold**` labels + list items
2. **Ambiguous parsing** - `**Label:**` requires markdown-aware parsing
3. **Inconsistent nesting** - Hard to tell parent/child fields apart

---

## Solution: Unified Syntax

v6.5 uses dedicated symbols for different purposes:

| Symbol | Purpose | Example |
|--------|---------|---------|
| `^` | All metadata (question-level AND in-field) | `^type multiple_choice_single`, `^Case_Sensitive No` |
| `@` | Top-level field markers | `@field: question_text`, `@end_field` |
| `@@` | Nested subfield markers | `@@field: blank_1`, `@@end_field` |
| `*` | Correct answer marker | `- option*` marks correct dropdown option |

### Why These Symbols?

- **`^`** - Single symbol for ALL metadata, simple prefix with space separator
- **`@`** - Established in v6.4 for field structure
- **`@@`** - Natural extension for nested/child fields (visually explicit hierarchy)
- **`*`** - Already used in v6.4 for dropdown correct answers

---

## Format Comparison

### v6.4 (mixed syntax):
```markdown
@question: Q001
@type: multiple_choice_single
@identifier: MC_Q001
@points: 1

@field: blanks

@field: blank_1
**Correct Answers:**
- 42
- 42.0
**Case Sensitive:** No
@end_field

@end_field
```

### v6.5 (unified syntax):
```markdown
^question Q001
^type multiple_choice_single
^identifier MC_Q001
^points 1

@field: blanks

@@field: blank_1
^Correct_Answers
- 42
- 42.0
^Case_Sensitive No
@@end_field

@end_field
```

**Benefits:**
- One symbol (`^`) for ALL metadata
- Clear visual hierarchy (`@` = top, `@@` = nested)
- No markdown parsing needed inside fields
- Simpler regex patterns

---

## Complete Examples by Question Type

### multiple_choice_single

```markdown
# Q001 Question Title
^question Q001
^type multiple_choice_single
^identifier MC_Q001
^title Question Title
^points 1
^labels #Course #Topic #Bloom #Difficulty

@field: question_text
What is the correct answer?
@end_field

@field: options
^Shuffle Yes
A. Wrong option
B. Correct option
C. Wrong option
D. Wrong option
@end_field

@field: answer
B
@end_field

@field: feedback

@@field: general_feedback
Explanation of the concept...
@@end_field

@@field: correct_feedback
Well done! B is correct because...
@@end_field

@@field: incorrect_feedback
Review the concept...
@@end_field

@end_field
```

### text_entry

```markdown
# Q004 Fill in the blank
^question Q004
^type text_entry
^identifier TE_Q001
^title Fill in the blank
^points 2
^labels #Course #Topic #Apply #Medium

@field: question_text
Calculate the value: {{BLANK-1}}
@end_field

@field: blanks

@@field: blank_1
^Correct_Answers
- 42
- 42.0
- forty-two
^Case_Sensitive No
@@end_field

@end_field

@field: scoring
^Points_per_correct_field 2
^Points_minimum 0
@end_field

@field: feedback

@@field: general_feedback
The correct answer is 42...
@@end_field

@@field: correct_feedback
Correct!
@@end_field

@@field: incorrect_feedback
Incorrect. Check your calculations.
@@end_field

@end_field
```

### inline_choice

```markdown
# Q005 Dropdown question
^question Q005
^type inline_choice
^identifier IC_Q001
^title Dropdown question
^points 2
^labels #Course #Topic #Understand #Easy

@field: question_text
Bile is produced in {{DROPDOWN-1}} and stored in {{DROPDOWN-2}}.
@end_field

@field: dropdown_1
^Shuffle Yes
- the liver*
- the pancreas
- the gallbladder
@end_field

@field: dropdown_2
^Shuffle Yes
- the liver
- the pancreas
- the gallbladder*
@end_field

@field: scoring
^Points_per_correct_field 1
^Points_minimum 0
@end_field

@field: feedback

@@field: general_feedback
Explanation...
@@end_field

@end_field
```

### match

```markdown
# Q006 Match concepts
^question Q006
^type match
^identifier MA_Q001
^title Match concepts
^points 3
^labels #Course #Topic #Analyze #Medium

@field: question_text
Match the circulatory systems:
@end_field

@field: pairs
1. Pulmonary circulation -> Heart to lungs and back
2. Systemic circulation -> Heart to body and back
3. Double circulation -> Blood passes heart twice
@end_field

@field: distractors
- Single pass system
- Open circulation
@end_field

@field: scoring
^Partial_credit Yes
^Points_per_correct_pair 1
^Points_minimum 0
@end_field

@field: feedback

@@field: general_feedback
Review circulatory system concepts...
@@end_field

@end_field
```

---

## Metadata Reference

### Question-Level Metadata (required)

```markdown
^question Q001                    # Question ID
^type multiple_choice_single      # Question type
^identifier MC_Q001               # Unique identifier
^points 1                         # Point value
^labels #label1 #label2 #Bloom #Diff  # Labels as hashtags
```

### Question-Level Metadata (optional)

```markdown
^title Human-readable title       # Display title
^language sv                      # Language code
```

### In-Field Metadata

| Metadata | Values | Used In |
|----------|--------|---------|
| `^Correct_Answers` | List items below | blanks |
| `^Case_Sensitive` | `Yes` / `No` | blanks |
| `^Shuffle` | `Yes` / `No` | options, dropdowns |
| `^Points_per_correct_field` | integer | scoring |
| `^Points_per_correct_pair` | integer | scoring |
| `^Points_minimum` | integer | scoring |
| `^Partial_credit` | `Yes` / `No` | scoring |
| `^Tolerance` | decimal | numeric blanks |
| `^Input_type` | `text` / `math` / `numeric` | blanks |

---

## Parsing Rules

1. **Line-by-line parsing** - Each line is evaluated independently
2. **Prefix matching:**
   - `^key value` = Metadata (key-value pair)
   - `^Key` alone = Label for following list items
   - `@field:` = Start top-level field
   - `@@field:` = Start nested subfield
   - `@end_field` = End top-level field
   - `@@end_field` = End subfield
   - `- item` = List item
   - `- item*` = Correct option (dropdown)

3. **Stack-based nesting:**
   - Push on `@field:` or `@@field:`
   - Pop on corresponding `end_field`
   - Metadata applies to current (top of stack) field

---

## Implementation Status

The QTI-Generator parser (`src/parser/markdown_parser.py`) supports v6.5:

- `^type`, `^identifier`, `^points`, `^labels` header parsing
- `@@field:` / `@@end_field` subfield parsing
- `^Key value` in-field metadata parsing
- `_parse_blank_v65()` for blank subfields
- All 18 v6.5 test fixtures pass

---

## References

- Canonical spec: `MPC_MQG_v2/docs/specs/MQG_bb6_v6.5.md`
- Test fixtures: `tests/fixtures/v65/*.md`
